<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Akses Dokumen Tugas Mahasiswa Teknologi Informasi UM-Palembang</title>
    <link rel="icon" type="image/x-icon" href="https://firebasestorage.googleapis.com/v0/b/ruangbelajar-52a67.appspot.com/o/LOGO%20PRODI%202025.png?alt=media&token=a13b26cd-23c0-40bb-bd96-c4ff014673a1" />

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap");

      body {
        font-family: "Poppins", sans-serif;
        background-color: #f0f2f5;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        color: #333;
      }

      .container {
        padding: 20px;
        width: 100%;
        max-width: 600px;
        box-sizing: border-box;
      }

      .card {
        background: #ffffff;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        padding: 30px;
        text-align: center;
      }

      h2 {
        color: #4a4a4a;
        font-weight: 600;
        margin-bottom: 20px;
      }

      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .form-group textarea {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-family: "Poppins", sans-serif;
        font-size: 1rem;
        background-color: #f9f9f9;
        resize: vertical;
      }

      .search-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #555;
      }

      .form-group input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-size: 1rem;
        background-color: #f9f9f9;
        transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      }

      .form-group input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
      }

      .form-group select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-size: 1rem;
        background-color: #f9f9f9;
      }

      #fileList {
        list-style-type: none;
        padding: 0;
        text-align: left;
      }

      #fileList li {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background-color 0.2s ease;
      }

      #fileList li:hover {
        background-color: #e2e6ea;
      }

      #fileList li .file-name-text {
        color: #007bff;
        font-weight: 500;
        word-break: break-word;
        flex-grow: 1;
      }

      #fileList li .file-number {
        font-weight: 600;
        color: #6c757d;
        margin-right: 15px;
      }

      .action-buttons {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .preview-btn,
      .download-btn,
      .delete-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
      }

      .preview-btn img,
      .download-btn img,
      .delete-btn img {
        width: 24px;
        height: 24px;
      }

      .status-message {
        margin-top: 20px;
        color: #555;
      }

      .empty-message {
        color: #888;
        font-style: italic;
      }

      /* --- Dialog PIN --- */
      .pin-dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .pin-dialog-card {
        background: #ffffff;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        padding: 40px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        animation: fadeIn 0.3s ease-in-out;
      }

      .pin-dialog-card h3 {
        color: #4a4a4a;
        margin-bottom: 20px;
      }

      .pin-dialog-card input {
        width: 80%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        text-align: center;
      }

      .pin-dialog-card .dialog-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
      }

      .pin-dialog-card .dialog-actions button {
        width: 40%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .pin-dialog-card .dialog-actions #accessBtn {
        background-color: #007bff;
        color: #fff;
      }

      .pin-dialog-card .dialog-actions #accessBtn:hover {
        background-color: #0056b3;
      }

      .pin-dialog-card .dialog-actions #cancelBtn {
        background-color: #6c757d;
        color: #fff;
      }

      .pin-dialog-card .dialog-actions #cancelBtn:hover {
        background-color: #5a6268;
      }

      .error-message {
        color: #dc3545;
        margin-top: 10px;
        font-size: 0.9rem;
        min-height: 20px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* --- Dialog Login --- */
      .login-dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .login-dialog-card {
        background: #ffffff;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        padding: 40px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        animation: fadeIn 0.3s ease-in-out;
      }

      .login-dialog-card h3 {
        color: #4a4a4a;
        margin-bottom: 20px;
      }

      .login-dialog-card input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
      }

      .login-dialog-card .dialog-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
      }

      .login-dialog-card .dialog-actions button {
        width: 40%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .login-dialog-card .dialog-actions #loginBtn {
        background-color: #007bff;
        color: #fff;
      }

      .login-dialog-card .dialog-actions #loginBtn:hover {
        background-color: #0056b3;
      }

      .login-dialog-card .dialog-actions #closeLoginBtn:hover {
        background-color: #5a6268;
      }

      /* Tombol Akses */
      .access-button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin-bottom: 20px;
      }

      .access-open {
        background-color: #28a745;
        color: white;
      }

      .access-closed {
        background-color: #dc3545;
        color: white;
      }

      .toggle-section {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 20px;
        text-align: left;
      }

      .toggle-section button {
        width: 100%;
      }

      .notification-section {
        text-align: left;
        margin-bottom: 20px;
      }

      .notification-section textarea {
        min-height: 100px;
      }

      /* CSS for drag-and-drop feature */
      .drop-area-container {
        text-align: center;
        margin-bottom: 20px;
        display: none;
      }

      #dynamicDropArea {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 150px;
        padding: 20px;
        border: 2px dashed #ccc;
        border-radius: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      #dynamicDropArea.highlight {
        background-color: #e6f7ff;
        border-color: #007bff;
      }

      #dynamicDropArea p {
        margin: 0;
        color: #777;
        font-weight: 500;
      }

      .folder-list-container {
        text-align: left;
        margin-bottom: 20px;
      }

      .folder-list {
        list-style-type: none;
        padding: 0;
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: flex-start;
      }

      .folder-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        background-color: #f0f4f7;
        padding: 15px;
        border-radius: 10px;
        transition: background-color 0.2s ease, transform 0.2s ease;
        position: relative;
      }

      .folder-item:hover {
        background-color: #e2e6ea;
        transform: translateY(-2px);
      }

      .folder-item img.folder-icon {
        width: 40px;
        height: 40px;
        margin-bottom: 5px;
      }

      .folder-item span {
        font-size: 0.9em;
        text-align: center;
        word-break: break-all;
      }

      .folder-delete-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: background-color 0.2s ease;
      }
      .folder-delete-btn:hover {
        background-color: rgba(220, 53, 69, 0.1);
      }
      .folder-delete-btn img {
        width: 18px;
        height: 18px;
        filter: invert(100%) sepia(50%) saturate(1500%) hue-rotate(330deg) brightness(95%) contrast(100%);
      }

      /* Kelas baru untuk folder yang sedang aktif */
      .active-folder {
        background-color: #cce5ff !important;
        border-color: #007bff !important;
      }

      /* CSS for move-file feature */
      .move-file-section {
        display: none;
      }

      .create-folder-section {
        text-align: left;
        margin-bottom: 20px;
      }

      .create-folder-section .access-button {
        width: 100%;
      }

      #login-button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.3s ease;
        float: right;
      }

      #login-button:hover {
        background-color: #0056b3;
      }

      /* Media queries for desktop view */
      @media (min-width: 768px) {
        /* MENGEMBALIKAN LEBAR CONTAINER KE NORMAL */
        .container {
          max-width: 1000px;
        }

        .admin-flex-container {
          display: flex;
          flex-wrap: wrap;
          gap: 20px;
          justify-content: space-between;
          align-items: flex-start;
        }

        .admin-flex-item {
          flex: 1 1 calc(50% - 10px);
          margin-bottom: 20px;
        }

        .admin-flex-item:first-child {
          flex-basis: 100%;
        }

        .admin-flex-item .form-group,
        .admin-flex-item .access-button {
          max-width: 400px;
        }

        .folder-list-container,
        #fileList {
          max-width: 100%;
        }

        .folder-list {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
          gap: 15px;
        }

        .card {
          padding: 40px;
        }

        /* MENGEMBALIKAN KONTROL SCROLL KE BROWSER UTAMA */
        #report-table-fixed-container {
          overflow-x: auto; /* Aktifkan scroll horizontal pada kontainer */
        }

        /* Hapus lebar paksa agar browser menentukan lebar terbaik, dan tampilkan scrollbar jika terlalu lebar */
        .report-table-fixed th {
          white-space: nowrap;
        }

        .report-table-fixed input {
          width: 55px !important; /* Biarkan input tetap terukur */
        }
      }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  </head>

  <body>
    <div id="loginDialogOverlay" class="login-dialog-overlay">
      <div class="login-dialog-card">
        <h3>Login Admin</h3>
        <form id="loginForm">
          <input type="email" id="emailInput" placeholder="Masukkan Email" required />
          <input type="password" id="passwordInput" placeholder="Masukkan Password" required />
          <p id="loginErrorMessage" class="error-message"></p>
          <div class="dialog-actions">
            <button type="submit" id="loginBtn">Login</button>
          </div>
        </form>
      </div>
    </div>

    <div id="pinDialogOverlay" class="pin-dialog-overlay" style="display: none">
      <div class="pin-dialog-card">
        <h3 id="pinDialogTitle">Masukkan PIN</h3>
        <p id="pinDialogMessage">Untuk melanjutkan, Anda harus memasukkan PIN.</p>
        <form id="pinForm">
          <input type="password" id="pinInput" placeholder="Masukkan PIN" required />
          <p id="pinErrorMessage" class="error-message"></p>
          <div class="dialog-actions">
            <button type="button" id="cancelBtn">Batal</button>
            <button type="submit" id="accessBtn">Akses</button>
          </div>
        </form>
      </div>
    </div>

    <div id="mainContent" class="container">
      <div class="card">
        <button id="login-button">Login Admin</button>
        <br />
        <h2>Daftar Dokumen Tugas Mahasiswa Teknologi Informasi</h2>
        <hr style="margin: 30px 0; border: 0; border-top: 1px solid #e0e0e0" />

        <div id="admin-section" style="display: none">
          <button id="toggleAccessBtn" class="access-button">Memuat Status Akses...</button>
          <hr style="margin: 30px 0; border: 0; border-top: 1px solid #e0e0e0" />

          <div class="admin-flex-container">
            <div class="admin-flex-item">
              <h3 style="color: #4a4a4a; font-weight: 600; margin-bottom: 10px">Kelola Akses & Deadline Per Mata Kuliah</h3>
              <div class="toggle-section">
                <div class="form-group">
                  <label for="toggleCourseSelect">Pilih Mata Kuliah:</label>
                  <select id="toggleCourseSelect">
                    <option value="" disabled selected>-- Pilih salah satu --</option>
                  </select>
                </div>
                <button id="toggleCourseAccessBtn" class="access-button access-closed" disabled>Status: Memuat...</button>

                <div class="form-group">
                  <label for="courseDeadlineInput">Atur Batas Waktu Pengumpulan (Deadline):</label>
                  <input type="datetime-local" id="courseDeadlineInput" />
                </div>
                <button id="setDeadlineBtn" class="access-button access-open" disabled>Atur Deadline</button>
              </div>
            </div>

            <div class="admin-flex-item">
              <div class="create-report-section">
                <h4>Kelola Laporan Nilai ðŸ“Š</h4>
                <ul id="reportListContainer" class="folder-list" style="margin-bottom: 20px">
                  <p class="status-message">Memuat daftar laporan...</p>
                </ul>
                <div class="form-group">
                  <label for="newReportName">Nama Laporan Baru:</label>
                  <input type="text" id="newReportName" placeholder="Contoh: Nilai Akhir TI-5B" required />
                </div>
                <div class="form-group">
                  <label for="newReportPin">PIN untuk Laporan Baru:</label>
                  <input type="password" id="newReportPin" placeholder="Masukkan PIN" required />
                </div>
                <button id="createReportBtn" class="access-button access-open">Buat Laporan Baru</button>
              </div>
            </div>

            <div class="admin-flex-item">
              <div class="create-folder-section">
                <h4>Buat Folder Baru</h4>
                <div class="form-group">
                  <label for="newFolderName">Nama Mata Kuliah / Folder:</label>
                  <input type="text" id="newFolderName" placeholder="Masukkan nama folder" required />
                </div>
                <div class="form-group">
                  <label for="newFolderPin">PIN untuk Folder Baru:</label>
                  <input type="password" id="newFolderPin" placeholder="Masukkan PIN" required />
                </div>
                <button id="createFolderBtn" class="access-button access-open">Buat Folder & Atur PIN</button>
              </div>
            </div>

            <div class="admin-flex-item">
              <div class="notification-section">
                <h4>Kirim Notifikasi Manual</h4>
                <div class="form-group">
                  <label for="notificationTitle">Judul Notifikasi:</label>
                  <input type="text" id="notificationTitle" placeholder="Misal: Info Penting TI" required />
                </div>
                <div class="form-group">
                  <label for="notificationMessage">Pesan Notifikasi:</label>
                  <textarea id="notificationMessage" placeholder="Masukkan pesan notifikasi" rows="4" required></textarea>
                </div>
                <button id="sendNotificationBtn" class="access-button access-open">Kirim Notifikasi</button>
              </div>
            </div>
          </div>
          <hr style="margin: 30px 0; border: 0; border-top: 1px solid #e0e0e0" />
        </div>

        <div class="folder-list-container">
          <h4>Pilih Folder untuk Melihat atau Unggah</h4>
          <ul id="folderList" class="folder-list">
            <p class="status-message">Memuat daftar folder...</p>
          </ul>
          <p class="status-message" id="folder-status-message"></p>
        </div>

        <div class="search-group">
          <input type="text" id="fileSearch" placeholder="Cari nama file..." />
        </div>

        <ul id="fileList">
          <p class="status-message">Pilih folder di atas untuk melihat file.</p>
        </ul>
      </div>
    </div>

    <script>
      // Konfigurasi Firebase Anda
      const firebaseConfig = {
        apiKey: "AIzaSyCZAfnelUdrwUz856j2hC3yJWqUm-JJmiI",
        authDomain: "ruangbelajar-52a67.firebaseapp.com",
        databaseURL: "https://ruangbelajar-52a67-default-rtdb.firebaseio.com",
        projectId: "ruangbelajar-52a67",
        storageBucket: "ruangbelajar-52a67.appspot.com",
        messagingSenderId: "545318863560",
        appId: "1:545318863560:web:df392c010ff914aad49bfd",
        measurementId: "G-9M8CKR66BW",
      };

      // Inisialisasi Firebase
      firebase.initializeApp(firebaseConfig);
      const storage = firebase.storage();
      const database = firebase.database();
      const auth = firebase.auth();

      // Elemen DOM
      const mainContent = document.getElementById("mainContent");
      const loginDialogOverlay = document.getElementById("loginDialogOverlay");
      const loginForm = document.getElementById("loginForm");
      const emailInput = document.getElementById("emailInput");
      const passwordInput = document.getElementById("passwordInput");
      const loginErrorMessage = document.getElementById("loginErrorMessage");
      const adminSection = document.getElementById("admin-section");
      const loginButton = document.getElementById("login-button");

      const pinDialogOverlay = document.getElementById("pinDialogOverlay");
      const pinForm = document.getElementById("pinForm");
      const pinInput = document.getElementById("pinInput");
      const pinErrorMessage = document.getElementById("pinErrorMessage");
      const pinDialogTitle = document.getElementById("pinDialogTitle");
      const pinDialogMessage = document.getElementById("pinDialogMessage");
      const cancelBtn = document.getElementById("cancelBtn");

      const fileListContainer = document.getElementById("fileList");
      const toggleAccessBtn = document.getElementById("toggleAccessBtn");
      const fileSearchInput = document.getElementById("fileSearch");
      const toggleCourseSelect = document.getElementById("toggleCourseSelect");
      const toggleCourseAccessBtn = document.getElementById("toggleCourseAccessBtn");
      const newFolderNameInput = document.getElementById("newFolderName");
      const newFolderPinInput = document.getElementById("newFolderPin");
      const folderListContainer = document.getElementById("folderList");
      const createFolderBtn = document.getElementById("createFolderBtn");
      const folderStatusMessage = document.getElementById("folder-status-message");

      // DEADLINE ELEMENTS
      const courseDeadlineInput = document.getElementById("courseDeadlineInput");
      const setDeadlineBtn = document.getElementById("setDeadlineBtn");

      const notificationTitleInput = document.getElementById("notificationTitle");
      const notificationMessageInput = document.getElementById("notificationMessage");
      const sendNotificationBtn = document.getElementById("sendNotificationBtn");

      // ====== ELEMEN BARU UNTUK LAPORAN NILAI ======
      const reportListContainer = document.getElementById("reportListContainer");
      const newReportNameInput = document.getElementById("newReportName");
      const newReportPinInput = document.getElementById("newReportPin");
      const createReportBtn = document.getElementById("createReportBtn");
      const mainCard = document.querySelector(".card");
      // ============================================

      // Variabel State
      const courseAuthStatus = {};
      let cachedFiles = [];
      let currentFolderPath = null;
      let pendingAction = null;
      let activeFolderElement = null;

      // KOLOM-KOLOM HASIL PERHITUNGAN
      const RESULT_COLUMNS = ["NILAI TUGAS", "NILAI AKHIR", "NILAI HURUF", "BOBOT AKHIR"];

      // ===============================================
      // Â  Â  Â  Â  UTILITY FUNCTIONS FOR GRADES
      // ===============================================

      function getLetterGrade(score) {
        // Rentang Skor Akhir: 80-100 (A, 4), 68-79 (B, 3), 56-67 (C, 2), 40-55 (D, 1), 0-39 (E, 0)
        if (score >= 80) return { letter: "A", weight: 4, meaning: "Sangat Baik" };
        if (score >= 68) return { letter: "B", weight: 3, meaning: "Baik" };
        if (score >= 56) return { letter: "C", weight: 2, meaning: "Cukup" };
        if (score >= 40) return { letter: "D", weight: 1, meaning: "Gagal" };
        if (score >= 0) return { letter: "E", weight: 0, meaning: "Gagal" };
        // Kasus nilai negatif (Seharusnya tidak terjadi karena input min 0)
        return { letter: "T", weight: 0, meaning: "Tidak Ada" };
      }

      function calculateFinalGrade(row) {
        // Bobot: Tugas 20%, UTS 30%, UAS 50%
        const uts = parseFloat(row.UTS || 0);
        const uas = parseFloat(row.UAS || 0);

        let totalAssignmentScore = 0;
        let assignmentCount = 0;

        // Hitung rata-rata Nilai Tugas (semua TUGAS kecuali UTS dan UAS)

        for (let i = 1; i <= 16; i++) {
          const key = `TUGAS ${i}`;
          if (i !== 8 && i !== 16 && row.hasOwnProperty(key)) {
            const score = parseFloat(row[key]) || 0;
            totalAssignmentScore += score;
            assignmentCount++;
          }
        }

        const nilaitugas = assignmentCount > 0 ? totalAssignmentScore / assignmentCount : 0;

        // Formula: (NilaiTugas*20 + NilaiUTS*30 + NilaiUAS*50) / 100
        const nilaiAkhir = (nilaitugas * 20 + uts * 30 + uas * 50) / 100;

        const grade = getLetterGrade(nilaiAkhir);

        return {
          "NILAI TUGAS": nilaitugas.toFixed(2),
          "NILAI AKHIR": nilaiAkhir.toFixed(2),
          "NILAI HURUF": grade.letter,
          "BOBOT AKHIR": grade.weight,
        };
      }

      /**
       * Memperbarui kolom hasil (NILAI TUGAS, NILAI AKHIR, HURUF, BOBOT) di tabel HTML
       * untuk baris tertentu.
       * @param {Object} rowData - Data baris yang diperbarui (dari reportData.data[index]).
       * @param {number} rowIndex - Index baris (0-based) dalam array yang diurutkan.
       * @param {Array} columnNames - Daftar nama kolom laporan.
       */
      function updateResultColumns(rowData, rowIndex, columnNames) {
        const finalGrades = calculateFinalGrade(rowData);
        const tbody = document.querySelector(`#report-tbody-${window.currentReportKey}`);
        if (!tbody) return;

        // Cari elemen <tr> berdasarkan urutan tampilan (rowIndex)
        const rowElement = tbody.children[rowIndex];
        if (!rowElement) return;

        // Iterasi melalui kolom yang merupakan HASIL
        columnNames.forEach((colName, colIndex) => {
          if (RESULT_COLUMNS.includes(colName)) {
            // Temukan sel <td> yang sesuai
            const tdIndex = columnNames.indexOf(colName);
            const tdElement = rowElement.children[tdIndex];

            if (tdElement) {
              tdElement.textContent = finalGrades[colName];
              tdElement.style.backgroundColor = "#e9f8ff"; // Pastikan warna background hasil tetap
            }
          }
        });
      }

      // ===============================================
      // Â  Â  Â  Â  INIT & AUTH
      // ===============================================

      document.addEventListener("DOMContentLoaded", () => {
        auth.onAuthStateChanged((user) => {
          if (user) {
            showAdminView();
          } else {
            showLoginView();
          }
        });
      });

      // ===============================================
      // Â  Â  Â  Â  DEADLINE & COURSE ACCESS LOGIC
      // ===============================================

      toggleCourseSelect.addEventListener("change", () => {
        const courseKey = toggleCourseSelect.value;
        if (courseKey) {
          toggleCourseAccessBtn.disabled = false;
          setDeadlineBtn.disabled = false;
          updateCourseToggleButtonStatus(courseKey);
        } else {
          toggleCourseAccessBtn.textContent = "Status: Memuat...";
          toggleCourseAccessBtn.classList.remove("access-open", "access-closed");
          toggleCourseAccessBtn.disabled = true;
          setDeadlineBtn.disabled = true;
          courseDeadlineInput.value = "";
        }
      });

      setDeadlineBtn.addEventListener("click", () => {
        const courseKey = toggleCourseSelect.value;
        const courseName = toggleCourseSelect.options[toggleCourseSelect.selectedIndex].text;
        const deadline = courseDeadlineInput.value;

        if (!courseKey || !deadline) {
          alert("Mohon pilih Mata Kuliah dan atur waktu deadline terlebih dahulu.");
          return;
        }

        if (auth.currentUser) {
          showPinDialog("set_deadline", courseKey, `mengatur deadline ${courseName}`, null, { deadline });
        } else {
          alert("Anda harus login sebagai Admin untuk mengatur deadline.");
        }
      });

      async function setCourseDeadline(courseKey, deadlineString) {
        setDeadlineBtn.disabled = true;
        const originalText = setDeadlineBtn.textContent;
        setDeadlineBtn.textContent = "Menyimpan Deadline...";

        try {
          // Simpan deadline dalam format ISO string ke Firebase
          await database.ref(`akses_unggah/${courseKey}/deadline`).set(deadlineString);

          // Atur juga isOpen menjadi true saat deadline diatur, agar mahasiswa bisa unggah
          await database.ref(`akses_unggah/${courseKey}/isOpen`).set(true);

          alert(`Deadline untuk Mata Kuliah berhasil diatur pada: ${new Date(deadlineString).toLocaleString()}`);
          updateCourseToggleButtonStatus(courseKey);
        } catch (error) {
          console.error("Gagal mengatur deadline:", error);
          alert(`Gagal mengatur deadline: ${error.message}`);
        } finally {
          setDeadlineBtn.disabled = false;
          setDeadlineBtn.textContent = originalText;
        }
      }

      async function updateCourseToggleButtonStatus(courseKey) {
        try {
          const snapshot = await database.ref(`akses_unggah/${courseKey}`).once("value");
          const courseData = snapshot.val() || {};
          const isOpen = courseData.isOpen === true;
          const deadline = courseData.deadline;

          // 1. Update status tombol BUKA/TUTUP
          if (isOpen) {
            toggleCourseAccessBtn.textContent = "Akses Mata Kuliah: BUKA âœ…";
            toggleCourseAccessBtn.classList.remove("access-closed");
            toggleCourseAccessBtn.classList.add("access-open");
          } else {
            toggleCourseAccessBtn.textContent = "Akses Mata Kuliah: TUTUP ðŸ”’";
            toggleCourseAccessBtn.classList.remove("access-open");
            toggleCourseAccessBtn.classList.add("access-closed");
          }

          // 2. Update input deadline
          if (deadline) {
            // Set nilai input datetime-local
            courseDeadlineInput.value = deadline.substring(0, 16);
            // Ubah teks tombol deadline untuk menunjukkan status
            setDeadlineBtn.textContent = `Deadline Diatur: ${new Date(deadline).toLocaleString()}`;
          } else {
            courseDeadlineInput.value = "";
            setDeadlineBtn.textContent = "Atur Deadline";
          }
        } catch (error) {
          console.error("Gagal memperbarui status tombol mata kuliah:", error);
          toggleCourseAccessBtn.textContent = "Status tidak dapat dimuat.";
          setDeadlineBtn.textContent = "Gagal memuat deadline.";
        }
      }

      // ===============================================
      // Â  Â  Â  Â  UI & EVENT LISTENERS UMUM
      // ===============================================

      fileSearchInput.addEventListener("keyup", () => {
        filterFiles(fileSearchInput.value);
      });

      // PERBAIKAN LOGOUT
      loginButton.addEventListener("click", () => {
        if (auth.currentUser) {
          auth
            .signOut()
            .then(() => {
              showLoginView();
            })
            .catch((error) => {
              console.error("Logout failed:", error);
              alert("Gagal logout. Silakan coba lagi.");
            });
        } else {
          showLoginView();
        }
      });

      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = emailInput.value;
        const password = passwordInput.value;
        loginErrorMessage.textContent = "Sedang login...";
        try {
          const userCredential = await auth.signInWithEmailAndPassword(email, password);
          const user = userCredential.user;
          // Hanya UID admin yang diizinkan
          const adminUIDs = {
            rSaaJgKyEQRrh7nblW9pME6o7Ci1: true,
          };
          if (adminUIDs[user.uid]) {
            alert("Login berhasil! Selamat datang, Admin.");
            showAdminView();
          } else {
            await auth.signOut();
            loginErrorMessage.textContent = "Akses ditolak. Hanya admin yang diizinkan.";
            showLoginView();
          }
        } catch (error) {
          console.error("Login gagal:", error);
          loginErrorMessage.textContent = "Email atau password salah. Coba lagi.";
        }
      });

      function showAdminView() {
        mainContent.style.display = "block"; // Tampilkan konten utama
        loginDialogOverlay.style.display = "none"; // Sembunyikan dialog login
        loginButton.textContent = "Logout";
        loginButton.style.display = "block"; // Pastikan tombol login/logout terlihat
        adminSection.style.display = "block";
        updateAccessButtonStatus();
        fetchFolders();
        fetchCourseList();
        fetchReportList(); // <--- PANGGIL FUNGSI BARU

        // Pastikan tampilan default file/folder aktif
        document.querySelectorAll(".folder-list-container, .search-group, #fileList").forEach((el) => (el.style.display = "block"));
        document.querySelector("h2").textContent = "Daftar Dokumen Tugas Mahasiswa Teknologi Informasi";
        document.querySelector("hr").style.display = "block";

        // Sembunyikan semua tabel laporan jika ada
        document.querySelectorAll('[id^="report-table-"]').forEach((el) => el.remove());
      }

      function showLoginView() {
        mainContent.style.display = "none"; // âœ… Sembunyikan konten utama
        loginDialogOverlay.style.display = "flex"; // Tampilkan overlay login
        loginButton.textContent = "Login Admin";
        adminSection.style.display = "none";
        emailInput.value = "";
        passwordInput.value = "";
        loginErrorMessage.textContent = "";
      }

      // ===============================================
      // Â  Â  Â  Â  PIN DIALOG LOGIC
      // ===============================================

      pinForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const enteredPin = pinInput.value.trim();
        const actionType = pinDialogOverlay.dataset.actionType;
        const actionKey = pinDialogOverlay.dataset.actionKey;
        const selectedPath = pinDialogOverlay.dataset.selectedPath;
        const folderName = pinDialogOverlay.dataset.folderName;
        validatePin(enteredPin, actionType, actionKey, selectedPath, folderName);
      });

      cancelBtn.addEventListener("click", () => {
        pinDialogOverlay.style.display = "none";
        pinInput.value = "";
        pinErrorMessage.textContent = "";
        pendingAction = null;
      });

      function showPinDialog(actionType, actionKey, dialogTitle, selectedPath, data = null) {
        pinInput.value = "";
        pinErrorMessage.textContent = "";
        pinDialogTitle.textContent = `Masukkan PIN untuk ${dialogTitle}`;
        pinDialogMessage.textContent = "Untuk melanjutkan, Anda harus memasukkan PIN.";
        pinDialogOverlay.dataset.actionType = actionType;
        pinDialogOverlay.dataset.actionKey = actionKey;
        if (selectedPath) {
          pinDialogOverlay.dataset.selectedPath = selectedPath;
        } else {
          delete pinDialogOverlay.dataset.selectedPath;
        }
        if (data && data.folderName) {
          pinDialogOverlay.dataset.folderName = data.folderName;
        } else {
          delete pinDialogOverlay.dataset.folderName;
        }
        pendingAction = data;
        pinDialogOverlay.style.display = "flex";
      }

      async function validatePin(enteredPin, actionType, actionKey, selectedPath, folderName) {
        let pinToCheck = "";

        // PIN UNTUK LAPORAN NILAI
        if (actionType === "view_report" || actionType === "delete_report") {
          pinToCheck = await database
            .ref(`akses_pin/${actionKey}`) // actionKey adalah reportKey
            .once("value")
            .then((snap) => snap.val());
        }
        // PIN UNTUK AKSES GLOBAL
        else if (actionType === "toggle_access") {
          pinToCheck = await database
            .ref(`akses_pin/toggle_access_pin`)
            .once("value")
            .then((snap) => snap.val());
        }
        // PIN PER MATA KULIAH / FOLDER
        else if (actionType === "toggle_course_access" || actionType === "set_deadline" || actionType === "view_folder" || actionType === "delete_folder") {
          pinToCheck = await database
            .ref(`akses_pin/${actionKey}`)
            .once("value")
            .then((snap) => snap.val());
        } else {
          // Fallback, harusnya tidak tercapai
          pinToCheck = null;
        }

        if (enteredPin === pinToCheck) {
          pinErrorMessage.textContent = "";
          pinDialogOverlay.style.display = "none";

          if (actionType === "view_folder") {
            if (activeFolderElement) {
              activeFolderElement.classList.remove("active-folder");
            }
            const folderElement = document.querySelector(`.folder-item[data-folder-name="${folderName}"]`);
            if (folderElement) {
              folderElement.classList.add("active-folder");
              activeFolderElement = folderElement;
            }

            courseAuthStatus[actionKey] = true;
            fetchFiles(selectedPath);
          }
          // LOGIKA UNTUK TAMPILKAN LAPORAN NILAI SETELAH PIN BENAR
          else if (actionType === "view_report") {
            const reportKey = actionKey;
            const reportName = pendingAction.reportName;

            // Hapus semua tabel laporan yang mungkin sudah dibuat, untuk memastikan hanya 1 yang aktif
            document.querySelectorAll('[id^="report-table-"]').forEach((el) => el.remove());

            const reportTableId = `report-table-${reportKey}`;
            let reportElement = document.createElement("div");
            reportElement.id = reportTableId;
            reportElement.style.marginTop = "20px";
            mainCard.appendChild(reportElement);

            displayReportTable(reportKey, reportName); // Panggil fungsi render utama
          }
          // LOGIKA UNTUK HAPUS LAPORAN SETELAH PIN BENAR
          else if (actionType === "delete_report") {
            await deleteReport(actionKey, pendingAction.reportName);
            pendingAction = null;
          } else if (actionType === "toggle_access") {
            await _toggleAccessStatusLogic("akses");
          } else if (actionType === "toggle_course_access") {
            await _toggleAccessStatusLogic(`akses_unggah/${actionKey}/isOpen`);
          } else if (actionType === "delete_folder") {
            await deleteFolder(pendingAction.folderName, pendingAction.folderKey);
            pendingAction = null;
          } else if (actionType === "set_deadline") {
            pendingAction = null;
          }
        } else {
          pinErrorMessage.textContent = "PIN salah! Silakan coba lagi.";
        }
      }

      // ===============================================
      // Â  Â  Â  Â  FOLDER & FILE LOGIC
      // ===============================================

      async function fetchFolders() {
        const storageRef = storage.ref("dokumen");
        folderStatusMessage.textContent = "Memuat daftar folder...";
        try {
          const listResult = await storageRef.listAll();
          displayFolders(listResult.prefixes);
          if (listResult.prefixes.length > 0) {
            folderStatusMessage.textContent = "";
          } else {
            folderStatusMessage.textContent = "Belum ada folder yang dibuat.";
          }
        } catch (error) {
          console.error("Gagal mengambil daftar folder:", error);
          folderStatusMessage.textContent = `Gagal memuat folder: ${error.message}`;
        }
      }

      function displayFolders(prefixes) {
        folderListContainer.innerHTML = "";
        if (prefixes.length === 0) {
          folderListContainer.innerHTML = '<p class="empty-message">Belum ada folder yang dibuat.</p>';
          return;
        }

        prefixes.forEach((prefix) => {
          const folderName = prefix.name;
          const folderKey = folderName.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
          const folderItem = document.createElement("li");
          folderItem.classList.add("folder-item");
          folderItem.dataset.folderName = folderName;
          folderItem.innerHTML = `
            Â  Â  Â  Â  Â  Â  Â  Â  <img src="https://img.icons8.com/color/48/000000/folder-invoices.png" alt="Folder Icon" class="folder-icon" />
            Â  Â  Â  Â  Â  Â  Â  Â  <span>${folderName}</span>
            Â  Â  Â  Â  Â  Â  Â  Â  <button class="folder-delete-btn" data-folder-name="${folderName}" style="display: ${auth.currentUser ? "block" : "none"};">
            Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="https://img.icons8.com/material-outlined/24/000000/trash--v1.png" alt="Hapus Folder" />
            Â  Â  Â  Â  Â  Â  Â  Â  </button>
            Â  Â  Â  Â  Â  Â  `;

          folderItem.addEventListener("click", () => {
            const path = `dokumen/${folderName}/`;
            showPinDialog("view_folder", folderKey, `melihat folder ${folderName}`, path, { folderName });
          });

          const deleteButton = folderItem.querySelector(".folder-delete-btn");
          if (deleteButton) {
            deleteButton.addEventListener("click", (e) => {
              e.stopPropagation();
              if (auth.currentUser && confirm(`Apakah Anda yakin ingin menghapus folder "${folderName}" beserta seluruh isinya? Aksi ini tidak dapat dibatalkan.`)) {
                showPinDialog("delete_folder", folderKey, `menghapus folder ${folderName}`, null, { folderName, folderKey });
              }
            });
          }
          folderListContainer.appendChild(folderItem);
        });
      }

      createFolderBtn.addEventListener("click", () => {
        const folderName = newFolderNameInput.value.trim();
        const folderPin = newFolderPinInput.value.trim();
        if (!folderName || !folderPin) {
          alert("Mohon masukkan nama folder dan PIN terlebih dahulu.");
          return;
        }
        createFolder(folderName, folderPin);
      });

      async function createFolder(folderName, folderPin) {
        createFolderBtn.disabled = true;
        const originalBtnText = createFolderBtn.textContent;
        createFolderBtn.textContent = "Sedang membuat...";

        // 1. Buat key yang unik dan aman dari nama folder
        const folderKey = folderName.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();

        try {
          // 2. Cek apakah folder dengan key ini sudah ada di database
          const snapshot = await database.ref(`mata_kuliah/${folderKey}`).once("value");
          if (snapshot.exists()) {
            alert(`Folder "${folderName}" sudah ada. Mohon gunakan nama lain.`);
            return; // Hentikan proses jika folder sudah ada
          }

          // Lanjutkan proses pembuatan jika folder belum ada
          const folderPath = `dokumen/${folderName}/`;
          const placeholderFileName = ".gitkeep";
          const placeholderBlob = new Blob([], { type: "text/plain" });

          // Buat file placeholder di Firebase Storage untuk "membuat" folder
          const storageRef = storage.ref(`${folderPath}${placeholderFileName}`);
          await storageRef.put(placeholderBlob);

          // Simpan data folder baru ke database
          await database.ref(`akses_pin/${folderKey}`).set(folderPin);
          await database.ref(`akses_unggah/${folderKey}/isOpen`).set(true); // Default open
          await database.ref(`mata_kuliah/${folderKey}`).set(folderName);

          alert(`Folder "${folderName}" berhasil dibuat dengan PIN. Akses unggah diatur ke BUKA.`);
          newFolderNameInput.value = "";
          newFolderPinInput.value = "";
          fetchFolders();
          fetchCourseList();
        } catch (error) {
          console.error("Gagal membuat folder:", error);
          alert(`Gagal membuat folder: ${error.message}`);
        } finally {
          createFolderBtn.disabled = false;
          createFolderBtn.textContent = originalBtnText;
        }
      }

      async function deleteFolder(folderName, folderKey) {
        const folderRef = storage.ref(`dokumen/${folderName}`);
        try {
          // Hapus semua file di dalam folder (termasuk .gitkeep jika ada)
          const listResult = await folderRef.listAll();
          const deletePromises = listResult.items.map((fileRef) => fileRef.delete());
          await Promise.all(deletePromises);

          // Hapus entri dari Realtime Database
          const dbPromises = [database.ref(`akses_pin/${folderKey}`).remove(), database.ref(`akses_unggah/${folderKey}`).remove(), database.ref(`mata_kuliah/${folderKey}`).remove()];
          await Promise.all(dbPromises);

          alert(`Folder "${folderName}" berhasil dihapus beserta seluruh databasenya.`);
          fetchFolders();
          fetchCourseList();
          fileListContainer.innerHTML = '<p class="status-message">Pilih folder di atas untuk melihat file.</p>';
        } catch (error) {
          console.error("Gagal menghapus folder:", error);
          alert(`Gagal menghapus folder: ${error.message}`);
        }
      }

      async function fetchFiles(path) {
        currentFolderPath = path;
        const storageRef = storage.ref(path);
        fileListContainer.innerHTML = '<p class="status-message">Memuat daftar file...</p>';

        try {
          const listResult = await storageRef.listAll();
          cachedFiles = [];
          const filePromises = listResult.items.map(async (itemRef) => {
            if (itemRef.name === ".gitkeep") return null;
            const downloadURL = await itemRef.getDownloadURL();
            const fileName = itemRef.name;
            const filePath = itemRef.fullPath;
            const fileExtension = fileName.split(".").pop().toLowerCase();
            return { fileName, downloadURL, filePath, fileExtension };
          });

          cachedFiles = (await Promise.all(filePromises)).filter((file) => file !== null);
          displayFiles(cachedFiles);
        } catch (error) {
          console.error("Gagal mengambil data file:", error);
          fileListContainer.innerHTML = `<p class="status-message" style="color:#dc3545;">Gagal memuat file: ${error.message}</p>`;
        }
      }

      function filterFiles(searchTerm) {
        const filtered = cachedFiles.filter((file) => file.fileName.toLowerCase().includes(searchTerm.toLowerCase()));
        displayFiles(filtered);
      }

      function displayFiles(files) {
        fileListContainer.innerHTML = "";
        if (files.length === 0) {
          fileListContainer.innerHTML = '<p class="empty-message">Tidak ada file yang ditemukan.</p>';
          return;
        }

        let fileNumber = 1;
        files.forEach((file) => {
          const li = document.createElement("li");
          const fileNumberSpan = document.createElement("span");
          fileNumberSpan.classList.add("file-number");
          fileNumberSpan.textContent = `${fileNumber}.`;

          const fileNameSpan = document.createElement("span");
          fileNameSpan.classList.add("file-name-text");
          fileNameSpan.textContent = file.fileName;

          const actionButtonsDiv = document.createElement("div");
          actionButtonsDiv.classList.add("action-buttons");

          // Preview Button Logic
          const supportedPreviewExtensions = ["pdf", "doc", "docx", "ppt", "pptx", "xls", "xlsx"];
          if (supportedPreviewExtensions.includes(file.fileExtension)) {
            const previewBtn = document.createElement("a");
            previewBtn.classList.add("preview-btn");
            previewBtn.target = "_blank";
            let viewerUrl = file.fileExtension === "pdf" ? file.downloadURL : `https://docs.google.com/gview?url=${encodeURIComponent(file.downloadURL)}&embedded=true`;
            previewBtn.href = viewerUrl;
            const previewIcon = document.createElement("img");
            previewIcon.src = "https://img.icons8.com/material-outlined/24/000000/visible.png";
            previewIcon.alt = "Pratinjau";
            previewBtn.appendChild(previewIcon);
            actionButtonsDiv.appendChild(previewBtn);
          }

          // Download Button
          const downloadBtn = document.createElement("a");
          downloadBtn.href = file.downloadURL;
          downloadBtn.classList.add("download-btn");
          downloadBtn.target = "_blank";
          downloadBtn.download = file.fileName;
          const downloadIcon = document.createElement("img");
          downloadIcon.src = "https://img.icons8.com/material-outlined/24/000000/download--v1.png";
          downloadIcon.alt = "Unduh";
          downloadBtn.appendChild(downloadIcon);
          actionButtonsDiv.appendChild(downloadBtn);

          // Delete Button (Admin Only)
          const deleteBtn = document.createElement("button");
          deleteBtn.classList.add("delete-btn");
          const deleteIcon = document.createElement("img");
          deleteIcon.src = "https://img.icons8.com/material-outlined/24/000000/trash--v1.png";
          deleteIcon.alt = "Hapus";
          deleteBtn.appendChild(deleteIcon);
          deleteBtn.style.display = auth.currentUser ? "block" : "none";

          deleteBtn.addEventListener("click", () => {
            if (auth.currentUser && confirm(`Apakah Anda yakin ingin menghapus file "${file.fileName}"?`)) {
              deleteFile(file.filePath);
            }
          });

          actionButtonsDiv.appendChild(deleteBtn);
          li.appendChild(fileNumberSpan);
          li.appendChild(fileNameSpan);
          li.appendChild(actionButtonsDiv);
          fileListContainer.appendChild(li);
          fileNumber++;
        });
      }

      async function deleteFile(filePath) {
        const fileRef = storage.ref(filePath);
        try {
          await fileRef.delete();
          alert(`File berhasil dihapus.`);
          fetchFiles(currentFolderPath);
        } catch (error) {
          console.error("Gagal menghapus file:", error);
          alert(`Gagal menghapus file: ${error.message}`);
        }
      }

      // ===============================================
      // Â  Â  Â  Â  ACCESS TOGGLE & NOTIFICATION LOGIC
      // ===============================================

      toggleAccessBtn.addEventListener("click", () => {
        showPinDialog("toggle_access", "toggle_access_pin", "mengubah status akses global", null);
      });

      toggleCourseAccessBtn.addEventListener("click", () => {
        const courseKey = toggleCourseSelect.value;
        if (courseKey) {
          const courseName = toggleCourseSelect.options[toggleCourseSelect.selectedIndex].text;
          showPinDialog("toggle_course_access", courseKey, `mengubah status akses ${courseName}`, null);
        } else {
          alert("Mohon pilih mata kuliah terlebih dahulu.");
        }
      });

      async function fetchCourseList() {
        try {
          const snapshot = await database.ref("mata_kuliah").once("value");
          const courses = snapshot.val();

          // Bersihkan dropdown
          while (toggleCourseSelect.options.length > 1) {
            toggleCourseSelect.remove(1);
          }

          if (courses) {
            for (const key in courses) {
              if (Object.hasOwnProperty.call(courses, key)) {
                const courseName = courses[key];
                const option = document.createElement("option");
                option.value = key;
                option.textContent = courseName;
                toggleCourseSelect.appendChild(option);
              }
            }
          } else {
            console.log("No courses found in the database.");
          }
          const currentSelection = toggleCourseSelect.value;
          if (currentSelection) {
            updateCourseToggleButtonStatus(currentSelection);
          }
        } catch (error) {
          console.error("Gagal memuat daftar mata kuliah:", error);
        }
      }

      async function updateAccessButtonStatus() {
        try {
          const snapshot = await database.ref("akses").once("value");
          const isOpen = snapshot.val();
          if (isOpen === true) {
            toggleAccessBtn.textContent = "Akses Website: BUKA âœ…";
            toggleAccessBtn.classList.remove("access-closed");
            toggleAccessBtn.classList.add("access-open");
          } else {
            toggleAccessBtn.textContent = "Akses Website: TUTUP ðŸ”’";
            toggleAccessBtn.classList.remove("access-open");
            toggleAccessBtn.classList.add("access-closed");
          }
        } catch (error) {
          console.error("Gagal memperbarui status tombol:", error);
          toggleAccessBtn.textContent = "Status tidak dapat dimuat.";
        }
      }

      async function _toggleAccessStatusLogic(dbPath) {
        try {
          const snapshot = await database.ref(dbPath).once("value");
          const currentStatus = snapshot.val();
          const newStatus = !currentStatus;
          await database.ref(dbPath).set(newStatus);

          if (dbPath === "akses") {
            updateAccessButtonStatus();
          } else {
            // dbPath is like 'akses_unggah/mk_key/isOpen'
            const parts = dbPath.split("/");
            const courseKey = parts[1];
            updateCourseToggleButtonStatus(courseKey);
          }
          alert(`Akses berhasil diubah menjadi: ${newStatus ? "DIBUKA" : "DITUTUP"}`);
        } catch (error) {
          console.error("Gagal mengubah status akses:", error);
          alert(`Gagal mengubah status akses: ${error.message}`);
        }
      }

      sendNotificationBtn.addEventListener("click", () => {
        const title = notificationTitleInput.value.trim();
        const message = notificationMessageInput.value.trim();
        if (!title || !message) {
          alert("Judul dan pesan tidak boleh kosong.");
          return;
        }
        sendManualNotification(title, message);
      });

      async function sendManualNotification(title, message) {
        sendNotificationBtn.disabled = true;
        const originalBtnText = sendNotificationBtn.textContent;
        sendNotificationBtn.textContent = "Mengirim...";

        try {
          const notifRef = database.ref("notifikasi_manual");
          const snapshot = await notifRef.once("value");
          const currentNotif = snapshot.val();

          let newIdNumber = 1;
          if (currentNotif && currentNotif.id) {
            const lastId = currentNotif.id;
            const numberString = lastId.split("-").pop();
            const lastNumber = parseInt(numberString);
            if (!isNaN(lastNumber)) {
              newIdNumber = lastNumber + 1;
            }
          }

          const newId = `notif-penting-${String(newIdNumber).padStart(2, "0")}`;

          await notifRef.set({
            aktif: true,
            id: newId,
            judul: title,
            isi: message,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
          });

          alert("Notifikasi berhasil dikirim!");
          notificationTitleInput.value = "";
          notificationMessageInput.value = "";
        } catch (error) {
          console.error("Gagal mengirim notifikasi:", error);
          alert(`Gagal mengirim notifikasi: ${error.message}`);
        } finally {
          sendNotificationBtn.disabled = false;
          sendNotificationBtn.textContent = originalBtnText;
        }
      }

      // ===============================================
      //         LAPORAN NILAI LOGIC (FITUR BARU)
      // ===============================================

      async function fetchReportList() {
        reportListContainer.innerHTML = '<p class="status-message">Memuat daftar laporan...</p>';
        try {
          const snapshot = await database.ref("laporan_nilai").once("value");
          const reports = snapshot.val();
          reportListContainer.innerHTML = "";

          if (reports) {
            for (const key in reports) {
              const reportName = reports[key].name || key; // Gunakan key jika name tidak ada
              const reportItem = document.createElement("li");
              reportItem.classList.add("folder-item"); // Reuse folder-item style
              reportItem.dataset.reportKey = key;

              const deleteBtnHtml = `
                    <button 
                        class="folder-delete-btn delete-report-btn" 
                        data-report-key="${key}" 
                        data-report-name="${reportName}"
                        style="display: ${auth.currentUser ? "block" : "none"};"
                    >
                        <img src="https://img.icons8.com/material-outlined/24/000000/trash--v1.png" alt="Hapus Laporan" />
                    </button>
                `;

              reportItem.innerHTML = `
                Â  Â  Â  Â  Â  Â  Â  Â  <img src="https://img.icons8.com/color/48/000000/documents.png" alt="Report Icon" class="folder-icon" />
                Â  Â  Â  Â  Â  Â  Â  Â  <span>${reportName}</span>
                                ${deleteBtnHtml}
                Â  Â  Â  Â  Â  Â  `;

              // Event listener untuk melihat laporan
              reportItem.addEventListener("click", (e) => {
                // Jika yang diklik adalah tombol hapus, jangan tampilkan laporan
                if (e.target.closest(".delete-report-btn")) return;

                // --- MINTA PIN SEBELUM MELIHAT LAPORAN ---
                showPinDialog("view_report", key, `melihat laporan ${reportName}`, null, { reportName });
                // ----------------------------------------
              });

              // Event listener untuk menghapus laporan
              const deleteButton = reportItem.querySelector(".delete-report-btn");
              if (deleteButton) {
                deleteButton.addEventListener("click", (e) => {
                  e.stopPropagation();
                  if (auth.currentUser && confirm(`Apakah Anda yakin ingin menghapus Laporan Nilai "${reportName}"? Aksi ini tidak dapat dibatalkan.`)) {
                    showPinDialog("delete_report", key, `menghapus laporan ${reportName}`, null, { reportName: reportName });
                  }
                });
              }

              reportListContainer.appendChild(reportItem);
            }
          } else {
            reportListContainer.innerHTML = '<p class="empty-message">Belum ada laporan nilai yang dibuat.</p>';
          }
        } catch (error) {
          console.error("Gagal memuat daftar laporan:", error);
          reportListContainer.innerHTML = `<p class="status-message" style="color:#dc3545;">Gagal memuat laporan: ${error.message}</p>`;
        }
      }

      // FUNGSI BARU: HAPUS LAPORAN
      async function deleteReport(reportKey, reportName) {
        try {
          // 1. Hapus data laporan dari laporan_nilai
          await database.ref(`laporan_nilai/${reportKey}`).remove();

          // 2. Hapus PIN terkait dari akses_pin
          await database.ref(`akses_pin/${reportKey}`).remove();

          alert(`Laporan "${reportName}" berhasil dihapus.`);
          fetchReportList(); // Muat ulang daftar laporan

          // Bersihkan tampilan jika laporan yang dihapus sedang aktif
          document.querySelectorAll('[id^="report-table-"]').forEach((el) => el.remove());
          showAdminView();
        } catch (error) {
          console.error("Gagal menghapus laporan:", error);
          alert(`Gagal menghapus laporan: ${error.message}`);
        }
      }

      createReportBtn.addEventListener("click", () => {
        const reportName = newReportNameInput.value.trim();
        if (!reportName) {
          alert("Mohon masukkan nama laporan.");
          return;
        }
        createReport(reportName);
      });

      async function createReport(reportName) {
        createReportBtn.disabled = true;
        const originalBtnText = createReportBtn.textContent;
        createReportBtn.textContent = "Sedang membuat...";

        // --- AMBIL PIN BARU ---
        const reportPin = newReportPinInput.value.trim();
        if (!reportPin) {
          alert("PIN untuk Laporan Baru tidak boleh kosong.");
          createReportBtn.disabled = false;
          createReportBtn.textContent = originalBtnText;
          return;
        }
        // -----------------------

        // 1. Dapatkan daftar mahasiswa dari input user via prompt
        const studentListInput = prompt("Masukkan daftar mahasiswa (NIM, Nama Mahasiswa, L/P) per baris.\nContoh:\n162024001,NADA MAHARANI,P\n162024002,JUNIAIN RISKI,L\n\n(Kosongkan untuk data demo 3 mahasiswa)");

        if (studentListInput === null) {
          // User membatalkan prompt
          createReportBtn.disabled = false;
          createReportBtn.textContent = originalBtnText;
          return;
        }

        let rawStudents = [];
        if (studentListInput.trim() === "") {
          // Data demo jika user kosongkan
          rawStudents = ["162024001,NAMA DEMO SATU,P", "162024002,NAMA DEMO DUA,L", "162024003,NAMA DEMO TIGA,P"];
        } else {
          rawStudents = studentListInput
            .trim()
            .split("\n")
            .filter((line) => line.trim() !== ""); // Filter baris kosong
        }

        const taskColumns = [];
        for (let i = 1; i <= 16; i++) {
          // Kolom TUGAS 1 sampai TUGAS 16
          // Mengganti TUGAS 8 dan TUGAS 16
          if (i === 8) taskColumns.push("UTS");
          else if (i === 16) taskColumns.push("UAS");
          else taskColumns.push(`TUGAS ${i}`);
        }

        const studentData = [];

        // 2. Proses data input
        rawStudents.forEach((line) => {
          const parts = line.split(",").map((p) => p.trim());
          if (parts.length >= 3) {
            const nim = parts[0];
            const name = parts[1];
            const lp = parts[2].toUpperCase().substring(0, 1); // Ambil L atau P

            let studentRow = {
              NIM: nim,
              "NAMA MAHASISWA": name,
              L_P: lp,
              // Inisiasi nilai untuk kolom ujian
              UTS: 0,
              UAS: 0,
            };

            // Tambahkan kolom Tugas (1-7, 9-15) dengan nilai awal 0
            for (let i = 1; i <= 16; i++) {
              if (i === 8) studentRow["UTS"] = 0;
              else if (i === 16) studentRow["UAS"] = 0;
              else studentRow[`TUGAS ${i}`] = 0;
            }

            studentData.push(studentRow);
          }
        });

        if (studentData.length === 0) {
          alert("Input data mahasiswa tidak valid. Pastikan formatnya adalah NIM, Nama Mahasiswa, L/P dan minimal ada 1 mahasiswa.");
          createReportBtn.disabled = false;
          createReportBtn.textContent = originalBtnText;
          return;
        }

        // --- PENGURUTAN SEBELUM DISIMPAN KE FIREBASE ---
        studentData.sort((a, b) => {
          const nimA = parseInt(a.NIM);
          const nimB = parseInt(b.NIM);
          if (!isNaN(nimA) && !isNaN(nimB)) {
            return nimA - nimB; // Urutan berdasarkan angka NIM
          }
          return a.NIM.localeCompare(b.NIM); // Fallback ke pengurutan string
        });
        // ----------------------------------------------

        // 4. Tambahkan kolom hasil ke array kolom utama
        const columnsArray = ["NO", "NAMA MAHASISWA", "NIM", "L_P", ...taskColumns, ...RESULT_COLUMNS];

        try {
          const newReportRef = database.ref("laporan_nilai").push();
          const reportKey = newReportRef.key;

          await newReportRef.set({
            name: reportName, // Simpan nama laporan
            columns: columnsArray,
            data: studentData,
          });

          // --- SIMPAN PIN DI NODE AKSES_PIN ---
          await database.ref(`akses_pin/${reportKey}`).set(reportPin);
          // ------------------------------------

          alert(`Laporan "${reportName}" berhasil dibuat dengan PIN. Gunakan PIN ini untuk mengakses.`);
          newReportNameInput.value = "";
          newReportPinInput.value = ""; // Bersihkan input PIN
          fetchReportList();
        } catch (error) {
          console.error("Gagal membuat laporan:", error);
          alert(`Gagal membuat laporan: ${error.message}`);
        } finally {
          createReportBtn.disabled = false;
          createReportBtn.textContent = originalBtnText;
        }
      }

      function displayReportTable(reportKey, reportName) {
        // Simpan reportKey yang sedang aktif untuk fungsi update live
        window.currentReportKey = reportKey;

        // Sembunyikan semua konten utama
        document.querySelectorAll(".folder-list-container, .search-group, #fileList, #admin-section").forEach((el) => (el.style.display = "none"));
        document.querySelector("h2").textContent = `Laporan Nilai: ${reportName}`;
        document.querySelector("hr").style.display = "none";
        loginButton.style.display = "none";

        // Hapus semua tabel laporan yang mungkin sudah dibuat
        document.querySelectorAll('[id^="report-table-"]').forEach((el) => el.remove());

        const reportTableId = `report-table-${reportKey}`;
        let reportElement = document.createElement("div");
        reportElement.id = reportTableId;
        reportElement.style.marginTop = "20px";
        mainCard.appendChild(reportElement); // Sisipkan ke dalam card utama

        renderReportContent(reportElement, reportKey, reportName);
      }

      async function renderReportContent(container, reportKey, reportName) {
        container.innerHTML = `<p class="status-message">Memuat detail laporan...</p>`;

        // Tombol-tombol Aksi (BACK & EXPORT)
        const actionDiv = document.createElement("div");
        actionDiv.style.marginBottom = "15px";

        const backBtn = document.createElement("button");
        backBtn.textContent = "â¬…ï¸ Kembali ke Admin Dashboard";
        backBtn.classList.add("access-button", "access-closed");
        backBtn.style.marginRight = "10px";
        backBtn.style.marginBottom = "0";
        backBtn.addEventListener("click", () => {
          container.remove(); // Hapus tabel saat kembali
          delete window.currentReportKey; // Hapus state reportKey yang aktif
          showAdminView(); // Tampilkan kembali Admin View
        });
        actionDiv.appendChild(backBtn);

        const exportBtn = document.createElement("button");
        exportBtn.textContent = "Export ke CSV ðŸ“„";
        exportBtn.classList.add("access-button", "access-open");
        exportBtn.style.marginBottom = "0";
        exportBtn.addEventListener("click", () => exportReportToCSV(reportKey, reportName));
        actionDiv.appendChild(exportBtn);

        container.innerHTML = "";
        container.appendChild(actionDiv);

        const dataSnapshot = await database.ref(`laporan_nilai/${reportKey}`).once("value");
        const reportData = dataSnapshot.val();

        if (!reportData || !reportData.data || reportData.data.length === 0) {
          container.innerHTML += '<p class="empty-message">Tidak ada data mahasiswa dalam laporan ini.</p>';

          // Tambahkan tombol Add Student di sini juga jika list kosong
          const addStudentBtn = document.createElement("button");
          addStudentBtn.textContent = "â¬‡ï¸ Tambah Baris Mahasiswa Baru";
          addStudentBtn.classList.add("access-button", "access-open");
          addStudentBtn.style.marginTop = "15px";
          addStudentBtn.style.width = "100%";
          addStudentBtn.addEventListener("click", () => addNewStudentRow(reportKey, reportData.name));
          container.appendChild(addStudentBtn);

          return;
        }

        // --- PENGURUTAN SEBELUM DITAMPILKAN ---
        reportData.data.sort((a, b) => {
          const nimA = parseInt(a.NIM);
          const nimB = parseInt(b.NIM);
          if (!isNaN(nimA) && !isNaN(nimB)) {
            return nimA - nimB; // Urutan berdasarkan angka NIM
          }
          return a.NIM.localeCompare(b.NIM); // Fallback ke pengurutan string
        });
        // ------------------------------------

        const tableContainer = document.createElement("div");
        // Kontainer ini akan memiliki scrollbar jika tabel terlalu lebar
        tableContainer.id = "report-table-fixed-container";
        container.appendChild(tableContainer);

        const table = document.createElement("table");
        table.style.width = "auto"; // Mengizinkan tabel menyusut/melebar sesuai konten
        table.style.minWidth = "100%"; // Agar tetap memenuhi 100% jika layarnya cukup lebar
        table.style.borderCollapse = "collapse";

        // Buat kolom header
        let headerHtml = "<tr>";
        reportData.columns.forEach((col) => {
          let minWidth = "auto";
          let bgColor = "#007bff";

          // Tentukan lebar kolom nilai agar tampilan desktop optimal
          if (col.includes("TUGAS")) {
            minWidth = "80px";
          } else if (col === "NIM") {
            minWidth = "100px";
          } else if (col === "NAMA MAHASISWA") {
            minWidth = "150px";
          } else if (col === "UTS" || col === "UAS" || RESULT_COLUMNS.includes(col)) {
            minWidth = "100px";
          } else if (col === "NO" || col === "L_P") {
            minWidth = "40px";
          }

          if (RESULT_COLUMNS.includes(col)) {
            bgColor = "#17a2b8"; // Warna berbeda untuk hasil perhitungan
          }

          headerHtml += `<th class="report-table-fixed" style="border: 1px solid #ddd; padding: 8px; min-width: ${minWidth}; background-color: ${bgColor}; color: white; white-space: nowrap;">${col}</th>`;
        });
        headerHtml += "</tr>";

        table.innerHTML = `
          <thead style="color: white;">
            ${headerHtml}
          </thead>
          <tbody id="report-tbody-${reportKey}">
            </tbody>
        `;
        tableContainer.appendChild(table);

        const tbody = document.getElementById(`report-tbody-${reportKey}`);
        reportData.data.forEach((row, rowIndex) => {
          // Hitung nilai akhir untuk baris ini
          const finalGrades = calculateFinalGrade(row);

          const tr = document.createElement("tr");
          tr.dataset.rowIndex = rowIndex; // Simpan index urutan TAMPILAN

          reportData.columns.forEach((colName, colIndex) => {
            const td = document.createElement("td");
            td.style.border = "1px solid #ddd";
            td.style.padding = "8px";

            td.style.textAlign = ["NO", "L_P"].includes(colName) || colName.includes("TUGAS") || colName === "UTS" || colName === "UAS" ? "center" : "left";

            if (colName === "NO") {
              td.textContent = rowIndex + 1;
            } else if (RESULT_COLUMNS.includes(colName)) {
              // Kolom Hasil Perhitungan
              td.textContent = finalGrades[colName];
              td.style.backgroundColor = "#e9f8ff";
            } else if (["NAMA MAHASISWA", "NIM", "L_P"].includes(colName)) {
              // Kolom data identitas
              td.textContent = row[colName];
            } else {
              // Kolom nilai yang bisa diedit (TUGAS, UTS, UAS, dll.)
              const input = document.createElement("input");
              input.type = "number";
              input.min = 0;
              input.max = 100;
              input.value = row[colName] || 0;
              // Gunakan style inline untuk lebar input agar konsisten
              input.style.width = "55px";
              input.style.textAlign = "center";
              input.style.border = "1px solid #ccc";
              input.style.borderRadius = "4px";
              input.style.padding = "5px";
              input.style.boxSizing = "border-box";
              input.style.transition = "background-color 0.2s";

              input.dataset.colName = colName;
              input.dataset.rowIndex = rowIndex;

              input.addEventListener("change", async (e) => {
                const changedRowIndex = parseInt(e.target.dataset.rowIndex);
                const changedColName = e.target.dataset.colName;
                const newValue = parseInt(e.target.value) || 0;

                e.target.disabled = true;
                e.target.style.backgroundColor = "#fff3cd"; // Kuning: Menyimpan

                try {
                  // 1. Update data di array lokal (yang sudah diurutkan)
                  reportData.data[changedRowIndex][changedColName] = newValue;

                  // 2. Simpan SELURUH array data ke Firebase (Lebih aman untuk data yang diurutkan)
                  await database.ref(`laporan_nilai/${reportKey}/data`).set(reportData.data);

                  // 3. Update Kolom Hasil secara LIVE (tanpa render ulang tabel)
                  updateResultColumns(reportData.data[changedRowIndex], changedRowIndex, reportData.columns);

                  e.target.style.backgroundColor = "#d4edda"; // Hijau: Berhasil
                  setTimeout(() => {
                    e.target.style.backgroundColor = "white";
                    e.target.disabled = false;
                  }, 500);
                } catch (error) {
                  console.error("Gagal menyimpan nilai:", error);
                  e.target.style.backgroundColor = "#f8d7da"; // Merah: Error
                  alert("Gagal menyimpan nilai. Cek koneksi.");
                  setTimeout(() => {
                    e.target.style.backgroundColor = "white";
                    e.target.disabled = false;
                  }, 2000);
                }
              });
              td.appendChild(input);
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        // Tombol Tambah Kolom Nilai Baru (horizontal)
        const newColumnBtn = document.createElement("button");
        newColumnBtn.textContent = "âž• Tambah Kolom Nilai Baru";
        newColumnBtn.classList.add("access-button", "access-open");
        newColumnBtn.style.marginTop = "15px";
        newColumnBtn.style.width = "100%";
        newColumnBtn.addEventListener("click", () => {
          const newColName = prompt("Masukkan nama kolom nilai baru (Contoh: QUIZ atau TUGAS 17):");
          if (newColName && newColName.trim()) {
            addNewColumn(reportKey, newColName.trim().toUpperCase());
          } else if (newColName !== null) {
            alert("Nama kolom tidak boleh kosong.");
          }
        });
        container.appendChild(newColumnBtn);

        // Tombol Tambah Baris Mahasiswa Baru (vertikal)
        const addStudentBtn = document.createElement("button");
        addStudentBtn.textContent = "â¬‡ï¸ Tambah Baris Mahasiswa Baru (Otomatis Diurutkan)";
        addStudentBtn.classList.add("access-button", "access-open");
        addStudentBtn.style.marginTop = "15px";
        addStudentBtn.style.width = "100%";
        addStudentBtn.addEventListener("click", () => addNewStudentRow(reportKey, reportData.name));
        container.appendChild(addStudentBtn);
      }

      // ===============================================
      //         FUNGSI TAMBAH BARIS MAHASISWA BARU
      // ===============================================
      async function addNewStudentRow(reportKey, reportName) {
        const studentInput = prompt("Masukkan data mahasiswa baru (NIM, Nama Mahasiswa, L/P).\nContoh: 162024099,JOHN DOE,L");

        if (!studentInput) return; // Batal atau input kosong

        const parts = studentInput.split(",").map((p) => p.trim());
        if (parts.length < 3) {
          alert("Format input salah. Harap masukkan NIM, Nama Mahasiswa, dan L/P dipisahkan koma.");
          return;
        }

        const [nim, name, lpRaw] = parts;
        const lp = lpRaw.toUpperCase().substring(0, 1);

        if (!nim || !name || (lp !== "L" && lp !== "P")) {
          alert("Data tidak lengkap atau Jenis Kelamin (L/P) tidak valid.");
          return;
        }

        try {
          // 1. Ambil data laporan yang sudah ada
          const dataSnapshot = await database.ref(`laporan_nilai/${reportKey}`).once("value");
          const reportData = dataSnapshot.val();
          let currentData = reportData.data || [];
          const columns = reportData.columns;

          // Cek duplikasi NIM
          if (currentData.some((row) => row.NIM === nim)) {
            alert(`Mahasiswa dengan NIM ${nim} sudah ada di laporan ini.`);
            return;
          }

          // 2. Buat objek data mahasiswa baru
          let newStudentRow = {
            NIM: nim,
            "NAMA MAHASISWA": name,
            L_P: lp,
            UTS: 0,
            UAS: 0,
          };

          // 3. Isi nilai 0 untuk semua kolom tugas/nilai yang sudah ada
          columns.forEach((col) => {
            if (col.startsWith("TUGAS") || col === "UTS" || col === "UAS") {
              newStudentRow[col] = 0;
            }
          });

          // 4. Tambahkan ke array data saat ini
          currentData.push(newStudentRow);

          // 5. Urutkan kembali array data
          currentData.sort((a, b) => {
            const nimA = parseInt(a.NIM);
            const nimB = parseInt(b.NIM);
            if (!isNaN(nimA) && !isNaN(nimB)) {
              return nimA - nimB; // Urutan berdasarkan angka NIM
            }
            return a.NIM.localeCompare(b.NIM); // Fallback ke pengurutan string
          });

          // 6. Simpan kembali ke Firebase
          await database.ref(`laporan_nilai/${reportKey}/data`).set(currentData);

          alert(`Mahasiswa "${name}" berhasil ditambahkan ke laporan dan diurutkan berdasarkan NIM.`);

          // Render ulang tabel untuk menampilkan baris baru dengan urutan yang benar
          const oldTable = document.getElementById(`report-table-${reportKey}`);
          if (oldTable) oldTable.remove();
          displayReportTable(reportKey, reportName);
        } catch (error) {
          console.error("Gagal menambahkan baris mahasiswa:", error);
          alert(`Gagal menambahkan mahasiswa: ${error.message}`);
        }
      }

      async function addNewColumn(reportKey, newColName) {
        try {
          const dataSnapshot = await database.ref(`laporan_nilai/${reportKey}`).once("value");
          const reportData = dataSnapshot.val();

          if (reportData.columns.includes(newColName)) {
            alert(`Kolom dengan nama "${newColName}" sudah ada.`);
            return;
          }

          // Cek apakah kolom hasil akan tertimpa
          if (RESULT_COLUMNS.includes(newColName)) {
            alert(`Nama kolom "${newColName}" dicadangkan untuk hasil perhitungan.`);
            return;
          }

          // 1. Ambil kolom original tanpa kolom hasil
          const originalColumns = reportData.columns.filter((col) => !RESULT_COLUMNS.includes(col));

          // 2. Tambahkan kolom baru di sebelum kolom hasil
          const newColumns = [...originalColumns, newColName, ...RESULT_COLUMNS];

          await database.ref(`laporan_nilai/${reportKey}/columns`).set(newColumns);

          // 3. Inisialisasi nilai 0 untuk kolom baru di setiap baris data
          const newData = reportData.data.map((row) => ({
            ...row,
            [newColName]: 0, // Nilai awal 0
          }));
          await database.ref(`laporan_nilai/${reportKey}/data`).set(newData);

          alert(`Kolom "${newColName}" berhasil ditambahkan. Memuat ulang tabel...`);

          // Render ulang tabel untuk menampilkan kolom baru
          const oldTable = document.getElementById(`report-table-${reportKey}`);
          const reportName = reportData.name;
          if (oldTable) oldTable.remove();
          displayReportTable(reportKey, reportName);
        } catch (error) {
          console.error("Gagal menambahkan kolom:", error);
          alert(`Gagal menambahkan kolom: ${error.message}`);
        }
      }

      // Fungsi untuk Ekspor ke CSV
      async function exportReportToCSV(reportKey, reportName) {
        try {
          const snapshot = await database.ref(`laporan_nilai/${reportKey}`).once("value");
          const reportData = snapshot.val();

          if (!reportData || !reportData.data || reportData.data.length === 0) {
            alert("Tidak ada data untuk diekspor.");
            return;
          }

          const columns = reportData.columns;
          let data = reportData.data;

          // Urutkan data berdasarkan NIM sebelum diekspor
          data.sort((a, b) => {
            const nimA = parseInt(a.NIM);
            const nimB = parseInt(b.NIM);
            if (!isNaN(nimA) && !isNaN(nimB)) {
              return nimA - nimB;
            }
            return a.NIM.localeCompare(b.NIM);
          });

          // Siapkan data dengan kolom hasil yang sudah dihitung
          const dataWithGrades = data.map((row) => {
            const grades = calculateFinalGrade(row);
            return { ...row, ...grades };
          });

          // Header CSV
          let csvContent = columns.join(",") + "\n";

          // Isi Data
          dataWithGrades.forEach((row, index) => {
            const rowValues = columns.map((col) => {
              if (col === "NO") return index + 1;
              let value = row[col];

              // Logika Khusus untuk memastikan nilai numerik diekspor tanpa tanda kutip
              if (RESULT_COLUMNS.includes(col) || col.includes("TUGAS") || col === "UTS" || col === "UAS") {
                value = parseFloat(value); // Pastikan numerik
              }

              // Mengatasi koma/newline dalam data string (jika ada)
              if (typeof value === "string" && (value.includes(",") || value.includes("\n"))) {
                return `"${value.replace(/"/g, '""')}"`;
              }
              return value;
            });
            csvContent += rowValues.join(",") + "\n";
          });

          // Buat Blob dan Download
          const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
          const link = document.createElement("a");
          if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${reportName.replace(/\s/g, "_")}_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          } else {
            alert("Browser Anda tidak mendukung fitur download otomatis. Mohon salin konten CSV secara manual.");
          }
        } catch (error) {
          console.error("Gagal ekspor CSV:", error);
          alert(`Gagal mengekspor data: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
